package com.hanif.nagarfix

import android.app.Activity
import android.content.Intent
import android.os.Bundle
import androidx.activity.ComponentActivity
import androidx.activity.compose.setContent
import androidx.activity.compose.rememberLauncherForActivityResult
import androidx.activity.result.contract.ActivityResultContracts
import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.google.accompanist.swiperefresh.SwipeRefresh
import com.google.accompanist.swiperefresh.rememberSwipeRefreshState
import com.google.firebase.auth.FirebaseAuth
import com.google.firebase.database.*

data class HomePost(
    val id: String = "",
    val title: String = "",
    val description: String = "",
    val location: String = "",
    var likes: Int = 0,
    var dislikes: Int = 0,
    val userId: String = ""   
)

class HomeActivity : ComponentActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContent {
            HomeScreen(this)
        }
    }
}

@Composable
fun HomeScreen(activity: Activity) {
    val posts = remember { mutableStateListOf<HomePost>() }
    var isRefreshing by remember { mutableStateOf(false) }

    val database = FirebaseDatabase.getInstance()
    val postsRef = database.getReference("posts")

    val userLikes = remember { mutableStateMapOf<String, Boolean?>() }
    val currentUserId = FirebaseAuth.getInstance().currentUser?.uid ?: ""
    
    val editLauncher = rememberLauncherForActivityResult(ActivityResultContracts.StartActivityForResult()) { result ->
        if (result.resultCode == Activity.RESULT_OK) {
            val data = result.data
            if (data != null) {
                val updatedId = data.getStringExtra("id") ?: return@rememberLauncherForActivityResult
                val updatedTitle = data.getStringExtra("title") ?: ""
                val updatedDescription = data.getStringExtra("description") ?: ""
                val updatedLocation = data.getStringExtra("location") ?: ""
                
                val idx = posts.indexOfFirst { it.id == updatedId }
                if (idx != -1) {
                    posts[idx] = posts[idx].copy(
                        title = updatedTitle,
                        description = updatedDescription,
                        location = updatedLocation
                    )
                } else {
                    posts.removeAll { it.id == updatedId }
                }
            }
        }
    }
    
    LaunchedEffect(Unit) {
        fetchPostsOnce(postsRef, posts) { isRefreshing = it }
    }

    Scaffold(
        bottomBar = { BottomNavigationBar(activity) }
    ) { paddingValues ->
        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(paddingValues)
                .background(Color.White)
        ) {
            Box(
                modifier = Modifier
                    .padding(top = 0.dp)
                    .fillMaxWidth(fraction = 0.6f)
                    .height(50.dp)
                    .background(
                        color = Color(0xFF2E7D32),
                        shape = RoundedCornerShape(
                            topStart = 0.dp,
                            topEnd = 30.dp,
                            bottomStart = 0.dp,
                            bottomEnd = 0.dp
                        )
                    ),
                contentAlignment = Alignment.CenterStart
            ) {
                Text(
                    text = "NagarFix",
                    fontSize = 22.sp,
                    color = Color.White,
                    modifier = Modifier.padding(start = 16.dp)
                )
            }

            Spacer(modifier = Modifier.height(5.dp))

            SwipeRefresh(
                state = rememberSwipeRefreshState(isRefreshing),
                onRefresh = { fetchPostsOnce(postsRef, posts) { isRefreshing = it } },
                modifier = Modifier.fillMaxSize()
            ) {
                LazyColumn(
                    modifier = Modifier
                        .fillMaxSize()
                        .background(Color(0xFFF2F2F2)),
                    contentPadding = PaddingValues(8.dp),
                    verticalArrangement = Arrangement.spacedBy(8.dp)
                ) {
                    items(posts, key = { it.id }) { post ->
                        PostCard(
                            post = post,
                            userLikes = userLikes,
                            postsRef = postsRef,
                            onEdit = { p ->
                                val intent = Intent(activity, EditPostActivity::class.java).apply {
                                    putExtra("id", p.id)
                                    putExtra("title", p.title)
                                    putExtra("description", p.description)
                                    putExtra("location", p.location)
                                    putExtra("userId", p.userId)
                                }
                                editLauncher.launch(intent)
                            },
                            currentUserId = currentUserId
                        )
                    }
                }
            }
        }
    }
}

private fun fetchPostsOnce(postsRef: DatabaseReference, outList: MutableList<HomePost>, setRefreshing: (Boolean) -> Unit = {}) {
    setRefreshing(true)
    postsRef.addListenerForSingleValueEvent(object : ValueEventListener {
        override fun onDataChange(snapshot: DataSnapshot) {
            val tempList = mutableListOf<HomePost>()
            for (child in snapshot.children) {
                try {
                    val id = child.key ?: continue
                    val title = child.child("title").getValue(String::class.java) ?: "No Title"
                    val description = child.child("description").getValue(String::class.java) ?: "No Description"
                    val location = child.child("location").getValue(String::class.java) ?: "Unknown Location"
                    val likes = child.child("likes").getValue(Long::class.java)?.toInt() ?: 0
                    val dislikes = child.child("dislikes").getValue(Long::class.java)?.toInt() ?: 0
                    val userId = child.child("userId").getValue(String::class.java) ?: ""

                    tempList.add(HomePost(id, title, description, location, likes, dislikes, userId))
                } catch (_: Exception) { }
            }
            tempList.sortByDescending { it.id }
            outList.clear()
            outList.addAll(tempList)
            setRefreshing(false)
        }

        override fun onCancelled(error: DatabaseError) {
            setRefreshing(false)
        }
    })
}

@Composable
fun PostCard(
    post: HomePost,
    userLikes: MutableMap<String, Boolean?>,
    postsRef: DatabaseReference,
    onEdit: (HomePost) -> Unit,
    currentUserId: String
) {
    var likes by remember { mutableStateOf(post.likes) }
    var dislikes by remember { mutableStateOf(post.dislikes) }

    Card(
        modifier = Modifier
            .fillMaxWidth()
            .wrapContentHeight(),
        shape = RoundedCornerShape(12.dp),
        elevation = CardDefaults.cardElevation(4.dp)
    ) {
        Box(
            modifier = Modifier
                .fillMaxWidth()
                .padding(12.dp)
        ) {
            Column(modifier = Modifier.fillMaxWidth()) {
                Text(
                    text = post.title,
                    fontSize = 18.sp,
                    fontWeight = FontWeight.Bold
                )
                Text(
                    text = "Location: ${post.location}",
                    fontSize = 14.sp,
                    color = Color.Gray
                )

                Spacer(modifier = Modifier.height(6.dp))
                Text(text = post.description, fontSize = 15.sp)

                Spacer(modifier = Modifier.height(8.dp))
                Box(
                    modifier = Modifier
                        .fillMaxWidth()
                        .height(180.dp)
                        .background(Color.LightGray),
                    contentAlignment = Alignment.Center
                ) {
                    Text("Image Placeholder", color = Color.DarkGray)
                }

                Spacer(modifier = Modifier.height(8.dp))

                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.SpaceEvenly,
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    IconButton(onClick = {
                        when (userLikes[post.id]) {
                            true -> {
                                likes--
                                userLikes[post.id] = null
                                postsRef.child(post.id).child("likes").setValue(likes)
                            }
                            false, null -> {
                                if (userLikes[post.id] == false) dislikes = (dislikes - 1).coerceAtLeast(0)
                                likes++
                                userLikes[post.id] = true
                                postsRef.child(post.id).child("likes").setValue(likes)
                                postsRef.child(post.id).child("dislikes").setValue(dislikes)
                            }
                        }
                    }) {
                        Icon(
                            Icons.Filled.ThumbUp,
                            contentDescription = "Like",
                            tint = if (userLikes[post.id] == true) Color.Blue else Color.Gray
                        )
                    }
                    Text(text = "$likes")

                    IconButton(onClick = {
                        when (userLikes[post.id]) {
                            false -> {
                                dislikes--
                                userLikes[post.id] = null
                                postsRef.child(post.id).child("dislikes").setValue(dislikes)
                            }
                            true, null -> {
                                if (userLikes[post.id] == true) likes = (likes - 1).coerceAtLeast(0)
                                dislikes++
                                userLikes[post.id] = false
                                postsRef.child(post.id).child("likes").setValue(likes)
                                postsRef.child(post.id).child("dislikes").setValue(dislikes)
                            }
                        }
                    }) {
                        Icon(
                            Icons.Filled.ThumbDown,
                            contentDescription = "Dislike",
                            tint = if (userLikes[post.id] == false) Color.Red else Color.Gray
                        )
                    }
                    Text(text = "$dislikes")
                }
            }
            
            if (post.userId == currentUserId) {
                IconButton(
                    onClick = { onEdit(post) },
                    modifier = Modifier.align(Alignment.TopEnd)
                ) {
                    Icon(Icons.Filled.Edit, contentDescription = "Edit Post", tint = Color(0xFF2E7D32))
                }
            }
        }
    }
}

@Composable
fun BottomNavigationBar(activity: Activity) {
    val deepGreen = Color(0xFF006400)

    NavigationBar(containerColor = deepGreen) {
        NavigationBarItem(
            icon = {
                Icon(
                    Icons.Filled.Home,
                    contentDescription = "Home",
                    tint = Color(0xFF2E7D32)
                )
            },
            label = { Text("Home", color = Color.White) },
            selected = true,
            onClick = {
                val intent = Intent(activity, HomeActivity::class.java)
                intent.flags = Intent.FLAG_ACTIVITY_CLEAR_TASK or Intent.FLAG_ACTIVITY_NEW_TASK
                activity.startActivity(intent)
            }
        )

        NavigationBarItem(
            icon = {
                Icon(
                    Icons.Filled.Notifications,
                    contentDescription = "Notifications",
                    tint = Color.White
                )
            },
            label = { Text("Reports", color = Color.White) },
            selected = false,
            onClick = {
                val intent = Intent(activity, NotificationActivity::class.java)
                intent.flags = Intent.FLAG_ACTIVITY_CLEAR_TASK or Intent.FLAG_ACTIVITY_NEW_TASK
                activity.startActivity(intent)
            }
        )

        NavigationBarItem(
            icon = { Icon(Icons.Filled.Add, contentDescription = "Add", tint = Color.White) },
            label = { Text("Add", color = Color.White) },
            selected = false,
            onClick = {
                val intent = Intent(activity, AddPostActivity::class.java)
                intent.flags = Intent.FLAG_ACTIVITY_CLEAR_TASK or Intent.FLAG_ACTIVITY_NEW_TASK
                activity.startActivity(intent)
            }
        )

        NavigationBarItem(
            icon = {
                Icon(
                    Icons.Filled.Person,
                    contentDescription = "Profile",
                    tint = Color.White
                )
            },
            label = { Text("Profile", color = Color.White) },
            selected = false,
            onClick = {
                val intent = Intent(activity, ProfileActivity::class.java)
                intent.flags = Intent.FLAG_ACTIVITY_CLEAR_TASK or Intent.FLAG_ACTIVITY_NEW_TASK
                activity.startActivity(intent)
            }
        )
    }

}
