package com.hanif.nagarfix

import android.app.Activity
import android.content.Intent
import android.os.Bundle
import androidx.activity.ComponentActivity
import androidx.activity.compose.setContent
import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.google.accompanist.swiperefresh.SwipeRefresh
import com.google.accompanist.swiperefresh.rememberSwipeRefreshState
import com.google.firebase.database.*

data class NPost(
    val id: String = "",
    val title: String = "",
    val location: String = ""
)

class NotificationActivity : ComponentActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContent {
            NotificationScreen(this)
        }
    }
}

@Composable
fun NotificationScreen(activity: Activity) {
    val nposts = remember { mutableStateListOf<NPost>() }
    var isRefreshing by remember { mutableStateOf(false) }

    val database = FirebaseDatabase.getInstance()
    val postsRef = database.getReference("posts")

    // ‚úÖ Use real-time listener to reflect updates and deletions automatically
    LaunchedEffect(Unit) {
        isRefreshing = true
        postsRef.addValueEventListener(object : ValueEventListener {
            override fun onDataChange(snapshot: DataSnapshot) {
                val tempList = mutableListOf<NPost>()
                for (child in snapshot.children) {
                    try {
                        val id = child.key ?: continue
                        val title = child.child("title").getValue(String::class.java) ?: "No Title"
                        val location = child.child("location").getValue(String::class.java) ?: "Unknown Location"
                        tempList.add(NPost(id, title, location))
                    } catch (e: Exception) {
                        continue
                    }
                }
                // Sort by id descending (latest first)
                tempList.sortByDescending { it.id }
                nposts.clear()
                nposts.addAll(tempList)
                isRefreshing = false
            }

            override fun onCancelled(error: DatabaseError) {
                isRefreshing = false
            }
        })
    }

    Scaffold(bottomBar = { BottomNavigationBarNotification(activity) }) { padding ->
        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(padding)
                .background(Color(0xFFF2F2F2)),
            verticalArrangement = Arrangement.Top,
            horizontalAlignment = Alignment.Start
        ) {
            // Top Bar
            Box(
                modifier = Modifier
                    .padding(top = 0.dp)
                    .fillMaxWidth(fraction = 0.6f)
                    .height(50.dp)
                    .background(
                        color = Color(0xFF2E7D32),
                        shape = RoundedCornerShape(topEnd = 30.dp)
                    ),
                contentAlignment = Alignment.CenterStart
            ) {
                Text(
                    text = "Reports",
                    fontSize = 22.sp,
                    fontWeight = FontWeight.Bold,
                    color = Color.White,
                    modifier = Modifier.padding(start = 16.dp)
                )
            }

            Spacer(modifier = Modifier.height(10.dp))

            // Swipe refresh list
            SwipeRefresh(
                state = rememberSwipeRefreshState(isRefreshing),
                onRefresh = { /* Optional manual refresh */ },
                modifier = Modifier.fillMaxSize()
            ) {
                LazyColumn(
                    modifier = Modifier
                        .fillMaxSize()
                        .padding(horizontal = 16.dp),
                    verticalArrangement = Arrangement.spacedBy(12.dp)
                ) {
                    items(nposts, key = { it.id }) { post ->
                        NotificationItem(post)
                    }
                }
            }
        }
    }
}

@Composable
fun NotificationItem(post: NPost) {
    Card(
        modifier = Modifier.fillMaxWidth(),
        shape = RoundedCornerShape(16.dp),
        elevation = CardDefaults.cardElevation(6.dp)
    ) {
        Column(
            modifier = Modifier
                .background(Color(0xFFE0E0E0))
                .padding(16.dp)
        ) {
            Text(text = post.title, fontWeight = FontWeight.Bold, fontSize = 18.sp)
            Spacer(modifier = Modifier.height(6.dp))
            Text(text = "üìç Location: ${post.location}", fontSize = 15.sp)
        }
    }
}

@Composable
fun BottomNavigationBarNotification(activity: Activity) {
    val deepGreen = Color(0xFF006400)

    NavigationBar(containerColor = deepGreen) {
        NavigationBarItem(
            icon = { Icon(Icons.Default.Home, contentDescription = "Home", tint = Color.White) },
            label = { Text("Home", color = Color.White) },
            selected = false,
            onClick = {
                val intent = Intent(activity, HomeActivity::class.java)
                intent.flags = Intent.FLAG_ACTIVITY_CLEAR_TASK or Intent.FLAG_ACTIVITY_NEW_TASK
                activity.startActivity(intent)
            }
        )
        NavigationBarItem(
            icon = { Icon(Icons.Default.Notifications, contentDescription = "Reports", tint = Color(0xFF2E7D32)) },
            label = { Text("Reports", color = Color.White) },
            selected = true,
            onClick = {}
        )
        NavigationBarItem(
            icon = { Icon(Icons.Default.Add, contentDescription = "Add Post", tint = Color.White) },
            label = { Text("Add", color = Color.White) },
            selected = false,
            onClick = {
                val intent = Intent(activity, AddPostActivity::class.java)
                intent.flags = Intent.FLAG_ACTIVITY_CLEAR_TASK or Intent.FLAG_ACTIVITY_NEW_TASK
                activity.startActivity(intent)
            }
        )
        NavigationBarItem(
            icon = { Icon(Icons.Default.Person, contentDescription = "Profile", tint = Color.White) },
            label = { Text("Profile", color = Color.White) },
            selected = false,
            onClick = {
                val intent = Intent(activity, ProfileActivity::class.java)
                intent.flags = Intent.FLAG_ACTIVITY_CLEAR_TASK or Intent.FLAG_ACTIVITY_NEW_TASK
                activity.startActivity(intent)
            }
        )
    }
}
