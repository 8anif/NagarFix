package com.hanif.nagarfix

import android.app.Activity
import android.content.Context
import android.content.Intent
import android.os.Bundle
import androidx.activity.ComponentActivity
import androidx.activity.compose.setContent
import androidx.compose.foundation.Image
import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.datastore.preferences.core.booleanPreferencesKey
import androidx.datastore.preferences.core.edit
import androidx.datastore.preferences.preferencesDataStore
import com.google.firebase.auth.FirebaseAuth
import kotlinx.coroutines.flow.first
import kotlinx.coroutines.runBlocking

// Create DataStore instance
private val Context.dataStore by preferencesDataStore(name = "settings")

class ProfileActivity : ComponentActivity() {

    private val DARK_MODE_KEY = booleanPreferencesKey("dark_mode")

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        // Ensure user stays logged in until Logout
        val currentUser = FirebaseAuth.getInstance().currentUser
        if (currentUser == null) {
            startActivity(Intent(this, LoginActivity::class.java).apply {
                flags = Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_CLEAR_TASK
            })
            finish()
        }

        // Read dark mode preference synchronously at launch
        val isDarkMode = runBlocking {
            dataStore.data.first()[DARK_MODE_KEY] ?: false
        }

        setContent {
            var darkMode by remember { mutableStateOf(isDarkMode) }
            MyTheme(darkMode) {
                ProfileScreen(this, darkMode) {
                    darkMode = !darkMode
                    // Save preference persistently
                    saveDarkModePreference(darkMode)
                }
            }
        }
    }

    private fun saveDarkModePreference(enabled: Boolean) {
        runBlocking {
            dataStore.edit { preferences ->
                preferences[DARK_MODE_KEY] = enabled
            }
        }
    }
}

@Composable
fun MyTheme(darkTheme: Boolean, content: @Composable () -> Unit) {
    MaterialTheme(
        colorScheme = if (darkTheme) darkColorScheme(
            primary = Color(0xFF2E7D32),
            onPrimary = Color.White,
            secondary = Color(0xFF81C784),
            background = Color.Black,
            onBackground = Color.White,
            surface = Color.DarkGray,
            onSurface = Color.White,
        ) else lightColorScheme(
            primary = Color(0xFF2E7D32),
            onPrimary = Color.White,
            secondary = Color(0xFF81C784),
            background = Color(0xFFF8F9FA),
            onBackground = Color.Black,
            surface = Color.White,
            onSurface = Color.Black
        ),
        content = content
    )
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun ProfileScreen(activity: Activity, darkMode: Boolean, onToggleDarkMode: () -> Unit) {
    val deepGreen = Color(0xFF006400)
    val deepGreenLight = Color(0xFF2E7D32)

    Scaffold(
        bottomBar = {
            NavigationBar(containerColor = deepGreen) {
                val navItems = listOf(
                    Triple(Icons.Default.Home, "Home", HomeActivity::class.java),
                    Triple(Icons.Default.Notifications, "Reports", NotificationActivity::class.java),
                    Triple(Icons.Default.Add, "Add", AddPostActivity::class.java),
                    Triple(Icons.Default.Person, "Profile", ProfileActivity::class.java)
                )
                navItems.forEach { (icon, label, clazz) ->
                    NavigationBarItem(
                        icon = { Icon(icon, contentDescription = label) },
                        label = { Text(label) },
                        selected = clazz == ProfileActivity::class.java,
                        colors = NavigationBarItemDefaults.colors(
                            indicatorColor = Color.White,
                            selectedIconColor = deepGreen,
                            selectedTextColor = if (clazz == ProfileActivity::class.java) Color.White else deepGreen,
                            unselectedIconColor = Color.White,
                            unselectedTextColor = Color.White
                        ),
                        onClick = {
                            val intent = Intent(activity, clazz)
                            intent.flags = Intent.FLAG_ACTIVITY_CLEAR_TASK or Intent.FLAG_ACTIVITY_NEW_TASK
                            activity.startActivity(intent)
                        }
                    )
                }
            }
        }
    ) { padding ->
        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(padding)
                .background(MaterialTheme.colorScheme.background),
            verticalArrangement = Arrangement.Top,
            horizontalAlignment = Alignment.Start
        ) {
            // Title box
            Box(
                modifier = Modifier
                    .padding(top = 0.dp)
                    .fillMaxWidth(0.6f)
                    .height(50.dp)
                    .background(
                        color = deepGreenLight,
                        shape = RoundedCornerShape(
                            topStart = 0.dp,
                            topEnd = 30.dp,
                            bottomStart = 0.dp,
                            bottomEnd = 0.dp
                        )
                    ),
                contentAlignment = Alignment.CenterStart
            ) {
                Text(
                    text = "Profile",
                    fontSize = 22.sp,
                    fontWeight = FontWeight.Bold,
                    color = Color.White,
                    modifier = Modifier.padding(start = 16.dp)
                )
            }

            Spacer(Modifier.height(40.dp))

            // Header card
            Card(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(horizontal = 16.dp),
                shape = RoundedCornerShape(20.dp),
                elevation = CardDefaults.cardElevation(8.dp),
                colors = CardDefaults.cardColors(
                    containerColor = MaterialTheme.colorScheme.surface
                )
            ) {
                Box(
                    modifier = Modifier
                        .fillMaxWidth()
                        .background(
                            Brush.horizontalGradient(
                                colors = listOf(deepGreen.copy(alpha = 0.08f), Color.Transparent)
                            )
                        )
                        .padding(16.dp)
                ) {
                    Row(verticalAlignment = Alignment.CenterVertically) {
                        Image(
                            painter = painterResource(id = R.drawable.profile),
                            contentDescription = "Profile Image",
                            modifier = Modifier
                                .size(88.dp)
                                .clip(CircleShape)
                        )
                        Spacer(Modifier.width(16.dp))
                        Column {
                            Text(
                                text = "Abu Sayed Muhammed Hanif",
                                fontSize = 22.sp,
                                fontWeight = FontWeight.Bold,
                                color = deepGreen
                            )
                            Spacer(Modifier.height(6.dp))
                            Text(
                                text = "Active citizen",
                                fontSize = 14.sp,
                                color = MaterialTheme.colorScheme.onBackground.copy(alpha = 0.7f)
                            )
                        }
                    }
                }
            }

            Spacer(Modifier.height(24.dp))

            // Options
            OptionCard(
                icon = Icons.Default.Edit,
                iconTint = deepGreenLight,
                text = "Edit Profile",
                onClick = { activity.startActivity(Intent(activity, EditProfileActivity::class.java)) }
            )

            OptionCard(
                icon = Icons.Default.DarkMode,
                iconTint = deepGreenLight,
                text = "Dark Mode",
                trailing = {
                    Switch(
                        checked = darkMode,
                        onCheckedChange = { onToggleDarkMode() },
                        colors = SwitchDefaults.colors(
                            checkedThumbColor = Color.White,
                            checkedTrackColor = deepGreen,
                            uncheckedThumbColor = Color.Gray,
                            uncheckedTrackColor = Color.LightGray
                        )
                    )
                }
            )

            OptionCard(
                icon = Icons.Default.ExitToApp,
                iconTint = Color.Red,
                text = "Logout",
                textColor = Color.Red,
                onClick = {
                    FirebaseAuth.getInstance().signOut()
                    val intent = Intent(activity, MainActivity::class.java)
                    intent.flags = Intent.FLAG_ACTIVITY_CLEAR_TASK or Intent.FLAG_ACTIVITY_NEW_TASK
                    activity.startActivity(intent)
                    activity.finish()
                }
            )

            Spacer(Modifier.height(16.dp))
        }
    }
}

@Composable
private fun OptionCard(
    icon: androidx.compose.ui.graphics.vector.ImageVector,
    iconTint: Color,
    text: String,
    textColor: Color = Color.Black,
    trailing: (@Composable () -> Unit)? = null,
    onClick: (() -> Unit)? = null
) {
    Card(
        modifier = Modifier
            .fillMaxWidth()
            .padding(horizontal = 16.dp, vertical = 8.dp)
            .then(
                if (onClick != null) Modifier.clickable { onClick() } else Modifier
            ),
        shape = RoundedCornerShape(16.dp),
        colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surface),
        elevation = CardDefaults.cardElevation(6.dp)
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(14.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            Icon(icon, contentDescription = text, tint = iconTint)
            Spacer(Modifier.width(14.dp))
            Text(text, fontSize = 18.sp, fontWeight = FontWeight.Medium, color = textColor)
            Spacer(Modifier.weight(1f))
            trailing?.invoke()
        }
    }
}
